<!DOCTYPE html>
<html>
  <head>
  	<title>Community Dashboard</title>
  	<link href='http://fonts.googleapis.com/css?family=Roboto:400,500,700' rel='stylesheet' type='text/css'>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  	<script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  	<script src="js/eventjoy.storage.js"></script>
  	<script src="js/moment.js"></script>
  	<script type="text/javascript" src="lib/eventjoy.js"></script>
  	
    <!-- Stylesheet main-->
    <link rel="stylesheet" type="text/css" href="css/main-css.css">
    
    <script>
      var showing = false;
      function showSettings(){
        if(!showing){
          $('settings-view').removeClass('hidden');
          $('settings-view').addClass('showing');
          showing = true;
        }else{
          $('settings-view').removeClass('showing');
          $('settings-view').addClass('hidden');
          showing = false;
        }
      }
      function showOnboarding() {
        $('onboarding-view').removeClass('hidden');
        $('onboarding-view').addClass('showing');
        $('onboarding-view #onboarding-background').removeClass('hiding');
        $('onboarding-view .pages').addClass('hiding');
        $('onboarding-view #onboarding').removeClass('hidden');
        $('onboarding-view #loading').addClass('hiding').removeClass('active');
      }
      function hideOnboarding() {
        $('onboarding-view').addClass('hidden');
        $('onboarding-view').removeClass('showing');
        $('onboarding-view #onboarding').addClass('hidden');
        $('onboarding-view #loading').addClass('hidden').removeClass('active');
      }
      function showLoading() {
        $('onboarding-view #onboarding').addClass('hidden');
        $('onboarding-view #loading').removeClass('hidden').addClass('active');

        //setTimeout( showContent, 4000 );
      }
      var contentTimeout = null;
      function showContent() {
        clearTimeout( contentTimeout );
        if ( $('onboarding-view #loading').hasClass('active') ) {
          $('onboarding-view #onboarding-background').addClass('hiding');
          $('onboarding-view .pages').addClass('hiding');
          $('#main-content').removeClass('hidden');
          setTimeout( function() {
            hideOnboarding();
          }, 750);
        } else {
          contentTimeout = setTimeout(showContent, 1000);
        }
      }
    </script>
  
    <!-- Polymer import -->
    <link rel="import" href="bower_components/polymer/polymer.html">

  	<!-- Eventjoy Defined Polymer Dom Elements -->
    <link rel="import" href="eventjoy-dom-elements/onboarding-view.html">
    <link rel="import" href="eventjoy-dom-elements/main-card.html">
    <link rel="import" href="eventjoy-dom-elements/secondary-card.html">
    <link rel="import" href="eventjoy-dom-elements/event-footer.html">
    <link rel="import" href="eventjoy-dom-elements/settings-view.html">
  </head>

  <body>
    <div id="main-content" class="hidden">
    	<!-- This is where we want to define values dynamically -->
      <div id="main-card-wrapper">
      	<main-card headerimage="" registrationcount="1" ordertotal="$0.00" discountcode="NONE" promoter="NONE" style="display:none" class="incoming"></main-card>
        <!--<main-card headerimage="" registrationcount="1" ordertotal="$0.00" discountcode="NONE" promoter="NONE" style="display:none" class="incoming"></main-card>-->
      </div>

    	<div id="recent-activity">
        <p>RECENT ACTIVITY</p>
      </div>

      <div id="secondary-card-wrapper" >
          <!-- <secondary-card></secondary-card> -->
          <!-- <secondary-card></secondary-card>
          <secondary-card></secondary-card>
          <secondary-card></secondary-card> -->
      </div>
      
        <div id="footer-wrapper">
    	       <!-- Footer element -->
      	     <event-footer eventname='' revenue='0'  attendees='0'/>
        </div>
    </div>

    <!-- Settings view which is initially hidden -->
    <settings-view class="hidden"></settings-view>
    <onboarding-view class="hidden"></onboarding-view>
    </div>
    <script type="text/javascript">
      $(document).ready(function() {
      	eventjoy.setApiKey('64e86dc7f5f6e99874d53229601f2bef4653');
  		  localStorage.setItem('eventjoy_oauth_token', 'nKw0aWOyH8elGZntjbh79VWRbsoXImTIuohEghi1MD1LXQg++oRa8JnEWaxwkW7U9OlpyRfSb0YeRh6EOr7F0wwA4IhYgUCIp+2mF1leO3/DvIjAN6PeWoTu79BWM4VG')	;

    		if ( localStorage.getItem( 'eventjoy_access_token' ) ) {
    			// We aleady have an access token
    			console.log('found access token: '+localStorage.getItem('eventjoy_access_token'));
    			eventjoy.setAccessToken( localStorage.getItem('eventjoy_access_token') );
    		} else if ( localStorage.getItem( 'eventjoy_oauth_token' ) ) {
    			// No, but we we do have a oauth request token
    			console.log('found oauth token: '+localStorage.getItem('eventjoy_oauth_token'));
    			eventjoy.auth( localStorage.getItem('eventjoy_oauth_token'), function(success, response) {
    				localStorage.setItem( 'eventjoy_access_token', response.access_token);
    			});
    		}
    			
    		initialiseDB();

    		var eventID = 0;

    		// if eventID is passed in, it should be grabbed here.(Dropdown)
    		function getSpecificEvent(event_id) {
    			eventjoy.events(event_id, {}, function(success, events) {
    				if ( success && events ) {
    					if ( events.data ) {
    						// console.log(events.data);
    						event_id_for_orders = events.data.ID;
    						$("event-footer").attr("eventname", events.data.name);
    						$("event-footer").attr("eventdate", moment(events.data.startdate).format('MMMM D, YYYY'));
    						if(events.data && events.data.images && events.data.images.bodybg && events.data.images.bodybg[0]) {
    							$("main-card.incoming").attr("headerimage", events.data.images.bodybg[0]);
    						}
    					}
    				}
    			});
    		}

    		function getTicketName(ticket_id, ticketData) {
				// console.log(ticket_id);
				// console.log(ticketData);
				for(var x in ticketData.data) {
					if(ticket_id == ticketData.data[x].id) {
						return ticketData.data[x].name;	
					}
				}
				return "";
			}	

			function addPrimaryCard(event_id, order, discountcodes, promoter) {
				eventjoy.events_tickets(event_id, {}, function(status, ticketData) {
					// console.log(ticketData);
					// console.log(order.ID);
					eventjoy.order_attendees(order.ID, {}, function(status, attendeeData) {
						// console.log(order.ID);
						var attendees = [];
						for(x in attendeeData.data) {
							// console.log(attendeeData.data[x]);
							var ticketName = getTicketName(attendeeData.data[x].ticket_id, ticketData);
							var attendeeDetail = {
								"name" : attendeeData.data[x].attendee.name,
								"ticket_name" : ticketName
							};
							attendees.push(attendeeDetail);
						}
						// console.log(attendees);
						$("main-card.incoming").attr("attendeenames", JSON.stringify(attendees));
						$("main-card.incoming").attr("registrationcount", order.num_of_attendees);
						$("main-card.incoming").attr("ordertotal", order.total.slice(0, -3));
						$("main-card.incoming").attr("discountcode", discountcode);
						$("main-card.incoming").attr("promoter", promoter);
						$("main-card.incoming").show();
						localStorage.setItem("lastCompleted", order.completed);
					});
				});
			}

			function addSecondaryCard(idx, order, discountcode, promoter) {
				var element = $(".secondary-card-"+idx);
        if ( !element.length ) {
          element = $("<secondary-card class='secondary-card-"+idx+"' registrationcount='' ordertotal='' attendeenames='' discountcode='' promoter=''></secondary-card>");
				  $("#secondary-card-wrapper").append(element);
        }
				// console.log(element);
				eventjoy.order_attendees(order.ID, {}, function(status, attendeeData) {
					// console.log(order);
					var attendees = "";
					for(x in attendeeData.data) {
						attendees += attendeeData.data[x].attendee.name + ", ";
					}
					element.attr("registrationcount", order.num_of_attendees);
					element.attr("ordertotal", order.total.slice(0, -3));
					element.attr("attendeenames", attendees.slice(0, -2));
					element.attr("discountcode", discountcode);
					element.attr("promoter", promoter);
				});	
			}

			function getEventOrders(event_id, pageSize) {
				// console.log("Get Event Orders for "+event_id+"...");
				eventjoy.events_orders(event_id, {"page[number]": 1, "page[size]" : pageSize, "sort": "-completed"}, function(success, orders) {
					if ( success && orders ) {
						window.store.clearOrders();
						// console.log(orders);
						orders.data.forEach( function(order) {
							window.store.addOrder(order);
						});
					}
					window.store.getOrders("prev", 5, "", function( status, orders ) {
						for(var i in orders) {
							var order = orders[i];
							// console.log(order);
							discountcode = "NONE";
							if(order.discount_codes && order.discount_codes.length > 0) {
								discountcode = order.discount_codes[0];
							}
							var promoter = "NONE";
							if(order.promoter) {
								promoter = order.promoter;
							}
							if(i == 0) {
								addPrimaryCard(event_id, order, discountcode, promoter);
							}
							addSecondaryCard(i, order, discountcode, promoter);
						}
    				});
    				window.store.getTotalRevenue(function( status, totalRevenue ) {
    					window.store.getTotalAttendees(function( status, totalAttendees ) {
    						var footer = $("event-footer");
    						footer.attr("revenue", totalRevenue);
    						footer.attr("attendees", totalAttendees);

    						// console.log("Total Attendees: " + totalAttendees);
    					});
    					// console.log("Total Revenue: " + totalRevenue);
    				});

            // Once initial data is loaded, hide loading
            setTimeout( showContent, 1500 );
    			});
    		}

    		function reloadPageWithNewOrder(event_id) {
  				window.store.getOrders("prev", 5, localStorage.getItem("lastCompleted"), function( status, orders ) {
  					if(orders && orders.length > 0) {
  						for(var i in orders) {
  							var order = orders[i];
  							// console.log(order);
  							discountcode = "NONE";
  							if(order.discount_codes && order.discount_codes.length > 0) {
  								discountcode = order.discount_codes[0];
  							}
  							var promoter = "NONE";
  							if(order.promoter) {
  								promoter = order.promoter;
  							}
  							if(i == 0) {
  								addPrimaryCard(event_id, order, discountcode, promoter);
  							}
  							addSecondaryCard(i, order, discountcode, promoter);
  						}
  						window.store.getTotalRevenue(function( status, totalRevenue ) {
  	    					window.store.getTotalAttendees(function( status, totalAttendees ) {
  	    						var footer = $("event-footer");
  	    						footer.attr("revenue", totalRevenue);
  	    						footer.attr("attendees", totalAttendees);

  	    						// console.log("Total Attendees: " + totalAttendees);
  	    					});
  	    					// console.log("Total Revenue: " + totalRevenue);
  	    				});
  					}

            // Once initial data is loaded, hide loading
            setTimeout( showContent, 1500 );
  				});
    		}

    		if(eventID == 0) {
    			eventjoy.events("", {}, function(success, events) {
    				if ( success && events ) {
    					if ( events.data.length && events.data[0].ID ) {
                // Create event of array and pass it to dropdown
                var eventArrays = [];
                events.data.forEach(function(order) {
                  eventArrays.push({"eventName": order.name, "eventId" : order.ID});
                });

                $('onboarding-view').attr("event-array", JSON.stringify(eventArrays));

    						eventID = events.data[0].ID;
    						// eventID = 3677709;
    						getSpecificEvent(eventID);
    						getEventOrders(eventID, 5);
                getEventOrders(eventID, -1);
    					}
    				}
    			});
    		} else {
    			getSpecificEvent(eventID);	
    			getEventOrders(eventID, 5);
          getEventOrders(eventID, -1);
    		}

        window.newDataTransition = (function newDataTransition(changeData) {
          //$('#main-card-wrapper').addClass('move-right');
          $('#main-card-wrapper .transition').show().removeClass('move-off').removeClass('move-in').addClass('move-right');
          $('#secondary-card-wrapper .transition').each( function(idx, elem) {
            setTimeout( function() {
              $(elem).addClass('move-right');
            }, 100 * ($('.transition').length-idx));
            //}, 20 * idx);
          });

          setTimeout( function() {
            $('#main-card-wrapper .transition').show().removeClass('move-right').addClass('move-off');
          }, 650);

          setTimeout( function() {
            // This is where we shuffle the actual DOM elements, and reset the animation
            if ( changeData ) changeData();
            setTimeout( function() {
              $('.move-right').removeClass('move-right');
              $('#main-card-wrapper .transition').show().removeClass('move-off').addClass('move-in');
            }, 250);
          }, 1300);
        });

    		(function poll_data_into_database() {
			   setTimeout(function() {
			   		console.log("Polling for DB!!!");
			   		eventjoy.events_orders(eventID, {"page[number]": 1, "page[size]" : 50, "sort": "-completed"}, function(success, orders) {
			   			console.log(orders);
						if ( success && orders ) {
							orders.data.forEach( function(order) {
								// console.log(order);
								window.store.addOrder(order, function(success, order_id, order) {
									if(success) {
										console.log("Got new data :)");
										//reloadPageWithNewOrder(eventID);

                    // Animate the new data in
                    newDataTransition( function() {
                      reloadPageWithNewOrder(eventID);
                    });

									} else {
										// TODO: Get the latest in DB and compare completed against current one.
										// If multiple orders came in, current logic will not advance.
										console.log("No New Data :(");
									}
								});
							});
						}
					});
			   		poll_data_into_database();
			   }, 10000);
			})();
			// (function poll_data_into_page() {
			//    setTimeout(function() {
			//    		console.log("Polling for page")
			// 		// Get last five since last element
			// 		window.store.getOrders("prev", 5, localStorage.getItem("lastCompleted"), function( status, orders ) {
			//    			console.log(orders);
			// 			if(orders && orders.length > 0) {
			// 				console.log("New Item Available");
			// 			}
			// 		});
			//    		poll_data_into_page();
			//    }, 30000);
			// })();
      });

      // Start by showing onboarding
      showOnboarding();
    </script>
  </body>
</html>